const loadDelegacion=(e,o)=>dom.setValue("#del-id",e).setValue("#del-name",o),loadDelegaciones=(e,o,a)=>{const n=ab.parse(a.data);n&&(dom.setHtml("#delegacion",n.format('<option value="@value;">@label;</option>')),loadDelegacion(n[0].value,n[0].label)),unloading()};dom.ready(function(){const a={imp:0,iva:0},o={imp:i18n.isoFloat,fUxxi:i18n.fmtDate},n={msgError:"errForm",factura:{msgError:"errForm",tercero:i18n.required,"nif-tercero":i18n.required,delegacion:i18n.required,organica:i18n.required,"id-organica":i18n.required,memoria:i18n.required},lineas:{msgError:"errForm",desc:i18n.required,imp:i18n.gt0}},t={1:"132500",2:"155100",3:"131200",4:"131000",5:"131600",6:"154000",7:"132600",8:"13250200",9:"131300",10:"131501",12:"174100"},r=ab.parse(dom.getText("#lineas-json"))||[],i=e=>dom.setValue("#economica",t[e]),c=(e,o)=>{a.iva=+o;o=a.imp*(a.iva/100);dom.setText(e.cells[1],i18n.isoFloat(o)+" €").setText(e.nextElementSibling.cells[1],i18n.isoFloat(a.imp+o)+" €")};a.iva=+dom.getValue("#iva")??0,n.factura.economica=FACT.uae?i18n.required:null,dom.click("a#add-linea",e=>{dom.validate("#xeco-fact",n.lineas)&&(r.push(i18n.toData()),dom.table("#conceptos",r,a,o)),dom.setValue("#linea","").setValue("#imp","").setFocus("#linea")}),dom.onRenderTable("#conceptos",e=>{a.imp=0,r.forEach(e=>{a.imp+=e.imp}),dom.setValue("#lineas",JSON.stringify(r))}),dom.afterRenderTable("#conceptos",e=>{e.tFoot.querySelector("#iva").value=a.iva,c(e.tFoot.rows[1],a.iva)}),dom.table("#conceptos",r,a,o).onChangeTable("#conceptos",e=>c(a.row,a.element.value)),dom.swapAttr("#fMax","min","max").onChangeInputs("#subtipo",e=>i(e.value)).onChangeInputs(".face-common",o=>dom.eachInput(".face-common",e=>{e.value=o.value})).onChangeInput("#delegacion",e=>loadDelegacion(e.value,dom.getOptText(e))).onChangeSelect("#sujeto",e=>dom.toggleHide(".grupo-exento",0!=e.value)),dom.onChangeSelect("#face",e=>{n.factura.og=1==e.value?i18n.required:null,n.factura.plataforma=2==e.value?i18n.required:null,dom.toggleHide("div.grupo-face",1!=e.value).toggleHide("div.grupo-face-otras",2!=e.value)}),dom.onChangeSelect("#subtipo",e=>{dom.toggleHide("#grupo-recibo",9!=e.value&&3!=e.value).toggleHide(".grupo-deportes",10!=e.value)});function e(){this.value||(dom.setHtml("#delegacion",'<option value="">Seleccione una delegación</option>'),loadDelegacion("","Seleccione una delegación"),fnAcLoad(this,"",""))}dom.onLoadForm("#xeco-fact",e=>i(dom.getValue("#subtipo")),()=>{}),window.fnSend=()=>{if(!dom.validate("#xeco-fact",n.factura))return null;var e=i18n.toData();return ab.size(r)||dom.required("#linea","Debe detallar los conceptos asociados a la solicitud."),3!=e.subtipo&&9!=e.subtipo||e.refreb||dom.addError("#recibo","Debe indicar un número de recibo válido"),10==e.subtipo&&dom.required("#extra",n.msgError).leToday("#fMax",n.msgError),1==e.face&&dom.required("#og",n.msgError).required("#oc",n.msgError).required("#ut",n.msgError),2==e.face&&dom.required("#plataforma",n.msgError),e},$(".ac-tercero").attr("type","search").keydown(fnAcChange).autocomplete({delay:500,minLength:5,focus:fnFalse,search:fnAcSearch,source:function(e,o){fnAutocomplete(this.element,["nombre","nif"],o,e=>e.nif+" - "+e.nombre)},select:function(e,o){return loading(),!dom.setValue("#tercero",o.item.nif+" - "+o.item.nombre).setValue("#nif-tercero",o.item.nif).setValue("#id-tercero",o.item.id).trigger("#find-delegaciones","click")}}).change(e).on("search",e),$("#organica").attr("type","search").keydown(fnAcChange).autocomplete({delay:500,minLength:4,focus:fnFalse,search:fnAcSearch,source:fnSourceItems,select:fnSelectItem}).change(fnAcReset).on("search",fnAcReset),$(".ac-recibo").attr("type","search").keydown(fnAcChange).autocomplete({delay:500,focus:fnFalse,search:fnAcSearch,source:fnSourceItems,select:fnSelectItem}).change(fnAcReset).on("search",fnAcReset);let l,d;$("#uxxi").attr("type","search").keydown(fnAcChange).autocomplete({delay:500,minLength:3,focus:fnFalse,search:fnAcSearch,source:function(e,o){fnAutocomplete(this.element,["num","desc"],o,e=>e.num+" - "+e.uxxi+"<br>"+e.desc)},select:function(e,o){return l=o.item,fnAcLoad(this,null,l.num+" - "+l.desc)}}).change(fnAcReset).on("search",fnAcReset),d=ab.parse(dom.getText("#op-json"))||[],dom.click("a#add-uxxi",e=>{l&&(delete l.id,d.push(l),dom.table("#op-table",d,a,o)),dom.setValue("#uxxi","").setFocus("#uxxi")}),dom.table("#op-table",d,a,o),dom.onRenderTable("#op-table",e=>{dom.setValue("#operaciones",JSON.stringify(d)),l=null})});